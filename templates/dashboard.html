{% extends "base.html" %}
{% block content %}

<div class="row">

  {% if user.get('role') == 'admin' %}
  <div class="col-md-12">
    <div class="card p-3 mb-4 border-danger">
      <h4>âš™ï¸ Painel Administrativo</h4>
      <p>Acesso exclusivo do administrador.</p>
      <a href="/admin" class="btn btn-danger">Gerenciar usuÃ¡rios</a>
    </div>
  </div>
  {% endif %}

  <div class="col-md-6">

    <div class="card p-3">
      <h5>Bem-vindo, {{ user_id }}</h5>
      <p class="small-muted">Telefone cadastrado: <b>{{ user.get('phone','(nÃ£o cadastrado)') }}</b></p>
      <p>Status:
        {% if user.get('active') %}
          <span class="text-success">ATIVA</span>
        {% else %}
          <span class="text-danger">INATIVA</span>
        {% endif %}
      </p>

      {% if user.get('active') %}
        <button id="sendCode" class="btn btn-primary">ğŸ“© Enviar cÃ³digo</button>
      {% else %}
        <button class="btn btn-secondary" disabled>Assinatura inativa</button>
      {% endif %}
    </div>

    <div class="card p-3 mt-3">
      <h6>Confirmar cÃ³digo</h6>
      <input id="code" class="form-control mb-2" placeholder="CÃ³digo recebido">
      <button id="confirm" class="btn btn-primary">Confirmar</button>
      <div id="confirmResult" class="mt-2"></div>
    </div>

    <div class="card p-3 mt-3">
      <h6>Escolher grupo e enviar</h6>
      <button id="listGroups" class="btn btn-sm btn-primary mb-2">Carregar grupos</button>
      <select id="groups" class="form-control mb-2"></select>
      <textarea id="message" class="form-control mb-2" placeholder="Mensagem"></textarea>

      <div class="d-flex gap-2">
        <button id="startAttack" class="btn btn-danger">ğŸš€ ENVIAR EM LOOP</button>
        <button id="stopAttack" class="btn btn-secondary">âŒ CANCELAR</button>
      </div>

      <div id="status" class="mt-2 small-muted"></div>
    </div>
  </div>
</div>

<script>
async function postJSON(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  return res.json();
}

document.getElementById('sendCode')?.addEventListener('click', async ()=>{
  const r = await postJSON('/api/send_code', { phone: "{{ user.phone }}" });
  alert(JSON.stringify(r));
  window.phone_hash = r.phone_code_hash;
});

document.getElementById('confirm')?.addEventListener('click', async ()=>{
  const code = document.getElementById('code').value;
  const r = await postJSON('/api/confirm_code', {
    phone: "{{ user.phone }}",
    code: code,
    phone_hash: window.phone_hash
  });
  document.getElementById('confirmResult').innerText = JSON.stringify(r);
});

document.getElementById('listGroups')?.addEventListener('click', async ()=>{
  const r = await postJSON('/api/list_groups', { phone: "{{ user.phone }}" });
  const sel = document.getElementById('groups');
  sel.innerHTML = '';

  if(r.status === 'ok'){
    r.dialogs.forEach(d=>{
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.text = d.title;
      sel.appendChild(opt);
    });
  } else alert(JSON.stringify(r));
});

document.getElementById('startAttack')?.addEventListener('click', async ()=>{
  const gid = document.getElementById('groups').value;
  const msg = document.getElementById('message').value;

  const r = await postJSON('/api/start_attack', {
    phone: "{{ user.phone }}",
    chat_id: gid,
    message: msg
  });

  document.getElementById('status').innerText = JSON.stringify(r);
});

document.getElementById('stopAttack')?.addEventListener('click', ()=>{
  document.getElementById('status').innerText = 'Parado (nÃ£o implementado)';
});
</script>

{% endblock %}
