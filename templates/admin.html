{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Painel Admin â€” Gerenciar UsuÃ¡rios</h3>

<div class="card p-3 mb-4">
  <h5>âž• Criar usuÃ¡rio</h5>
  <div class="row g-2">
    <div class="col-md-3"><input id="new_uid" class="form-control" placeholder="ID (login)"></div>
    <div class="col-md-3"><input id="new_pass" class="form-control" placeholder="Senha"></div>
    <div class="col-md-3"><input id="new_phone" class="form-control" placeholder="Telefone"></div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" onclick="createUser()">Criar</button>
    </div>
  </div>
</div>

<div class="card p-3">
  <h5>ðŸ‘¥ UsuÃ¡rios</h5>
  <table class="table table-dark table-striped mt-3">
    <thead>
      <tr>
        <th>ID</th><th>Telefone</th><th>Assinatura</th><th>Senha</th><th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>

  <div class="mt-3">
    <button class="btn btn-outline-danger" onclick="clearLogs()">Apagar logs</button>
  </div>
</div>

<script>
async function jsonFetch(url, data){
  const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  return r.json();
}

function loadUsers(){
  fetch('/admin/list').then(r=>r.json()).then(users=>{
    let html = '';
    for(const uid in users){
      const u = users[uid];
      html += `<tr>
        <td>${uid}</td>
        <td><input id="p_${uid}" class="form-control" value="${u.phone || ''}"></td>
        <td>
          <select id="a_${uid}" class="form-control">
            <option value="true" ${u.active ? 'selected':''}>Ativa</option>
            <option value="false" ${!u.active ? 'selected':''}>Inativa</option>
          </select>
        </td>
        <td><input id="s_${uid}" class="form-control" placeholder="Nova senha"></td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="editUser('${uid}')">Salvar</button>
          <button class="btn btn-danger btn-sm" onclick="delUser('${uid}')">Excluir</button>
        </td>
      </tr>`;
    }
    document.getElementById('usersTable').innerHTML = html;
  });
}

function createUser(){
  const uid = document.getElementById('new_uid').value.trim();
  const pwd = document.getElementById('new_pass').value;
  const phone = document.getElementById('new_phone').value;
  if(!uid || !pwd){ alert('Preencha uid e senha'); return; }
  jsonFetch('/admin/create', {uid, password: pwd, phone, active:true}).then(r=>{
    if(r.status=='ok') { loadUsers(); alert('Criado'); }
    else alert(JSON.stringify(r));
  });
}

function editUser(uid){
  const pwd = document.getElementById('s_'+uid).value;
  const phone = document.getElementById('p_'+uid).value;
  const active = document.getElementById('a_'+uid).value === 'true';
  jsonFetch('/admin/edit', {uid, password: pwd, phone, active}).then(r=>{
    if(r.status=='ok'){ loadUsers(); alert('Salvo'); } else alert(JSON.stringify(r));
  });
}

function delUser(uid){
  if(!confirm('Excluir usuÃ¡rio?')) return;
  jsonFetch('/admin/delete', {uid}).then(r=>{
    if(r.status=='ok'){ loadUsers(); alert('Removido'); } else alert(JSON.stringify(r));
  });
}

function clearLogs(){
  if(!confirm('Apagar todos os logs?')) return;
  jsonFetch('/admin/clear_logs', {}).then(r=>{
    if(r.status=='ok'){ alert('Logs apagados'); } else alert(JSON.stringify(r));
  });
}

loadUsers();
</script>

{% endblock %}
